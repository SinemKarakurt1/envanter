<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Ürün Gönderimi</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: #ffffff;
      color: #333;
      padding: 80px 15px 20px;
      max-width: 1100px;
      margin: 0 auto;
    }

   header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 60px;
  background: #f8f9fa; /* Açık gri ton */
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05); /* Hafif gölge */
  padding: 0 24px;
  display: flex;
  align-items: center;
  gap: 16px;
  z-index: 100;
  user-select: none;
  border-bottom: 1px solid #e0e0e0; /* İnce alt çizgi */
}

  header h1 {
  margin: 0;
  font-weight: 700;
  font-size: 2.2rem;
  color: transparent;
  background: linear-gradient(90deg, #b31217, #e52d27); /* Kırmızı tonlarda geçişli yazı */
  -webkit-background-clip: text;
  background-clip: text;
  letter-spacing: 2.5px;
  font-family: 'Segoe UI', 'Poppins', sans-serif; /* Modern, şık fontlar */
  user-select: none;
  flex-grow: 1;
  text-align: center;

}

   form {
  margin-top: 40px;
  background: #f7f3f3;
  padding: 40px 40px;
  border-radius: 20px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
  display: flex;
  gap: 40px;
  margin-bottom: 50px;
  flex-wrap: wrap;
  transition: all 0.3s ease-in-out;
}

.left-side, .right-side {
  flex: 1 1 450px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

select,
input[type=text],
input[type=number] {
  padding: 14px 18px;
  border-radius: 12px;
  border: 1.5px solid #d1d5db;
  background: #f9fafb;
  font-size: 0.95rem;
  font-weight: 500;
  color: #111827;
  transition: border-color 0.3s, background 0.3s;
}

select:focus,
input:focus {
  border-color: #b91c1c;
  background: #fff;
  outline: none;
  box-shadow: 0 0 0 4px rgba(185, 28, 28, 0.15);
}

button {
  display: block;               /* Ortalamak için */
  margin: 30px auto 0;          /* Üstten biraz boşluk, otomatik yatay ortalama */
  padding: 10px 34px;           /* Daha dar hale getirildi */
  background: linear-gradient(135deg, #b91c1c, #ef4444);
  color: #fff;
  cursor: pointer;
  border: none;
  font-weight: 600;
  font-size: 1.3rem;            /* Biraz daha küçük */
  border-radius: 12px;
  transition: all 0.25s ease;
  box-shadow: 0 5px 15px rgba(185, 28, 28, 0.2);
  margin-right: 10px;;
}

button:hover {
  background: linear-gradient(135deg, #ef4444, #b91c1c);
  box-shadow: 0 10px 20px rgba(185, 28, 28, 0.3);
  transform: translateY(-2px);
}


.container h2 {
  text-align: center;
  color: #b31217;
  margin-bottom: 20px;
}

table thead {
  background: #eee;
}


 .container {
    width: 100vw; /* Tüm ekran genişliği */
    margin-left: calc(-50vw + 50%);
    background: #fff;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 6px 24px rgba(0, 0, 0, 0.05);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95rem;
    table-layout: fixed;
    word-wrap: break-word;
  }

  table th, table td {
    border: 1px solid #ddd;
    padding: 10px 12px;
    text-align: left;
    font-size: 0.95rem;
  }

  @media (max-width: 768px) {
    .left-side, .right-side {
      flex: 1 1 100%;
    }

    form {
      flex-direction: column;
    }
  }

  </style>
</head>
<body>

  <header>
  <h1>MÜDÜRLÜK GÖNDERİMİ</h1>
</header>

  <form id="movementForm">
    <div class="left-side">
      <select id="productType" required>
        <option value="" disabled selected>Ürün Türü Seçiniz</option>
        <option value="monitor">Monitor</option>
        <option value="keyboard">Klavye</option>
        <option value="mouse">Mouse</option>
      </select>

      <select id="brand" disabled required>
        <option value="" disabled selected>Marka Seçiniz</option>
      </select>

      <select id="model" disabled required>
        <option value="" disabled selected>Model Seçiniz</option>
      </select>

      <input type="text" id="ip" placeholder="IP" autocomplete="off" />
    </div>

    <div class="right-side">
      <select id="department" required>
        <option value="" disabled selected>Müdürlük Seçiniz</option>
      </select>

      <select id="branch" disabled required>
        <option value="" disabled selected>Şeflik Seçiniz</option>
      </select>

      <select id="person" disabled required>
        <option value="" disabled selected>Kişi Seçiniz</option>
      </select>

      <input type="number" id="quantity" placeholder="Miktar" min="1" required />

      <button type="submit">Gönder</button>
    </div>
  </form>

  <div class="container">
  <h2>Gönderilen Ürün Listesi</h2>
  <table>
    <thead>
      <tr>
        <th>Ürün</th>
        <th>Marka</th>
        <th>Model</th>
        <th>IP</th>
        <th>Miktar</th>
        <th>Tarih</th>
        <th>Müdürlük</th>
        <th>Şeflik</th>
        <th>Kişi</th>
      </tr>
    </thead>
    <tbody id="urunListesi">
      <!-- Firebase'den gelen veriler buraya eklenecek -->
    </tbody>
  </table>
</div>




<script type="module">
  import {
    initializeApp
  } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    getDocs,
    addDoc,
    Timestamp
  } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC6G7JfaTCSpvwkX4PXTTJ6I92LIpzkkxk",
    authDomain: "belediyeenvanter.firebaseapp.com",
    projectId: "belediyeenvanter",
    storageBucket: "belediyeenvanter.appspot.com",
    messagingSenderId: "1088833874170",
    appId: "1:1088833874170:web:2c2c1c069a9880917b8143"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const productTypeSelect = document.getElementById("productType");
  const brandSelect = document.getElementById("brand");
  const modelSelect = document.getElementById("model");
  const departmentSelect = document.getElementById("department");
  const branchSelect = document.getElementById("branch");
  const personSelect = document.getElementById("person");

  const productData = {
    monitor: {
      Samsung: ["S24F350", "U28E590", "C27F398"],
      LG: ["24MK600M", "27GL650F", "32QN600"],
      Dell: ["P2419H", "U2719D", "S2721QS"]
    },
    keyboard: {
      Logitech: ["K120", "K380", "MX Keys"],
      Microsoft: ["Ergonomic", "Bluetooth Keyboard"],
      Corsair: ["K70", "K95", "K68"]
    },
    mouse: {
      Logitech: ["MX Master 3", "G502 Hero", "M185"],
      Razer: ["DeathAdder", "Basilisk", "Naga"],
      Microsoft: ["Classic IntelliMouse", "Arc Mouse"]
    }
  };

  const personData = [];

   const seflikler = {
      "İnsan Kaynakları": ["Personel Şefliği", "Eğitim Şefliği", "Sosyal İşler Şefliği"],
      "Teknik Hizmetler": ["Bakım Şefliği", "İnşaat Şefliği", "Elektrik Şefliği"],
      "Mali Hizmetler": ["Muhasebe Şefliği", "Bütçe Şefliği", "Satın Alma Şefliği"]
    };

    function filtreleSeflik() {
      const mudurlukSelect = document.getElementById("mudurluk");
      const seflikSelect = document.getElementById("seflik");
      const secilenMudurluk = mudurlukSelect.value;

      seflikSelect.innerHTML = "";

      if (!secilenMudurluk) {
        seflikSelect.disabled = true;
        seflikSelect.innerHTML = `<option value="">Önce Müdürlük Seçin</option>`;
        return;
      }

      seflikSelect.disabled = false;

      seflikler[secilenMudurluk].forEach(seflik => {
        const option = document.createElement("option");
        option.value = seflik;
        option.textContent = seflik;
        seflikSelect.appendChild(option);
      });
    }

    window.filtreleSeflik = filtreleSeflik;

    async function listeleHareketler() {
  const urunListesi = document.getElementById("urunListesi");
  urunListesi.innerHTML = ""; // listeyi temizle

  const snapshot = await getDocs(collection(db, "hareketler"));
  snapshot.forEach(doc => {
    const data = doc.data();
    const tarih = data.date?.toDate().toLocaleString("tr-TR") || "-";
    const [type, brand, model] = (data.productName || "- - -").split(" - ");

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${type || "-"}</td>
      <td>${brand || "-"}</td>
      <td>${model || "-"}</td>
      <td>${data.ip || "-"}</td>
      <td>${data.quantity || "-"}</td>
      <td>${tarih}</td>
      <td>${data.toDepartment || "-"}</td>
      <td>${data.toBranch || "-"}</td>
      <td>${data.toPerson || "-"}</td>
    `;
    urunListesi.appendChild(row);
  });
}

 async function loadPersonData() {
  const snapshot = await getDocs(collection(db, "personeller"));
  snapshot.forEach(doc => {
    const data = doc.data();
    personData.push({
      name: data.isimSoyisim,
      department: data.mudurluk,
      branch: data.seflik
    });
  });

  // Eşsiz müdürlükleri getir
  const departments = [...new Set(personData.map(p => p.department))];
  departments.forEach(dep => {
    const option = document.createElement("option");
    option.value = dep;
    option.textContent = dep;
    departmentSelect.appendChild(option);
  });
}


  departmentSelect.addEventListener("change", () => {
    const selectedDep = departmentSelect.value;

    const branches = [...new Set(
      personData.filter(p => p.department === selectedDep).map(p => p.branch)
    )];

    branchSelect.innerHTML = `<option value="" disabled selected>Şeflik Seçiniz</option>`;
    personSelect.innerHTML = `<option value="" disabled selected>Kişi Seçiniz</option>`;
    personSelect.disabled = true;

    branches.forEach(branch => {
      const option = document.createElement("option");
      option.value = branch;
      option.textContent = branch;
      branchSelect.appendChild(option);
    });

    branchSelect.disabled = false;
  });

  branchSelect.addEventListener("change", () => {
    const selectedDep = departmentSelect.value;
    const selectedBranch = branchSelect.value;

    const people = personData
      .filter(p => p.department === selectedDep && p.branch === selectedBranch)
      .map(p => p.name);

    personSelect.innerHTML = `<option value="" disabled selected>Kişi Seçiniz</option>`;

    people.forEach(person => {
      const option = document.createElement("option");
      option.value = person;
      option.textContent = person;
      personSelect.appendChild(option);
    });

    personSelect.disabled = false;
  });

  // Ürün türü - marka - model alanları
  productTypeSelect.addEventListener("change", () => {
    const selectedType = productTypeSelect.value;
    brandSelect.innerHTML = `<option value="" disabled selected>Marka Seçiniz</option>`;
    modelSelect.innerHTML = `<option value="" disabled selected>Model Seçiniz</option>`;
    modelSelect.disabled = true;

    if (selectedType && productData[selectedType]) {
      Object.keys(productData[selectedType]).forEach(brand => {
        const option = document.createElement("option");
        option.value = brand;
        option.textContent = brand;
        brandSelect.appendChild(option);
      });
      brandSelect.disabled = false;
    } else {
      brandSelect.disabled = true;
      modelSelect.disabled = true;
    }
  });

  brandSelect.addEventListener("change", () => {
    const selectedType = productTypeSelect.value;
    const selectedBrand = brandSelect.value;

    modelSelect.innerHTML = `<option value="" disabled selected>Model Seçiniz</option>`;

    if (selectedType && selectedBrand && productData[selectedType][selectedBrand]) {
      productData[selectedType][selectedBrand].forEach(model => {
        const option = document.createElement("option");
        option.value = model;
        option.textContent = model;
        modelSelect.appendChild(option);
      });
      modelSelect.disabled = false;
    } else {
      modelSelect.disabled = true;
    }
  });

  // Firestore'dan stok miktarını kontrol eden fonksiyon
async function checkStock(productName, quantity) {
  const stokRef = collection(db, "stoklar");
  const snapshot = await getDocs(stokRef);

  for (const doc of snapshot.docs) {
    const data = doc.data();
    if (data.productName === productName) {
      return data.quantity >= quantity;
    }
  }

  return false; // stokta hiç bulunamadıysa
}

// Form submit işlemi
document.getElementById("movementForm").addEventListener("submit", async e => {
  e.preventDefault();

  const productType = productTypeSelect.value;
  const brand = brandSelect.value;
  const model = modelSelect.value;
  const quantity = parseInt(document.getElementById("quantity").value, 10);
  const toDepartment = departmentSelect.value;
  const toBranch = branchSelect.value;
  const toPerson = personSelect.value;
  const productName = `${productType} - ${brand} - ${model}`;

  // ✅ Önce stok kontrolü
  const stokVarMi = await checkStock(productName, quantity);

  if (!stokVarMi) {
    alert("Yeterli stok yok veya ürün bulunamadı. Gönderim yapılamaz.");
    return;
  }

  try {
    await addDoc(collection(db, "hareketler"), {
      date: Timestamp.now(),
      fromDepartment: "DEPO",
      toDepartment,
      toBranch,
      toPerson,
      productName,
      quantity
    });

    alert("Ürün başarıyla gönderildi!");
    e.target.reset();
    brandSelect.disabled = true;
    modelSelect.disabled = true;
    branchSelect.disabled = true;
    personSelect.disabled = true;
  } catch (error) {
    console.error("Gönderim hatası:", error);
    alert("Gönderim sırasında hata oluştu.");
  }
});


  // Form submit işlemi
  document.getElementById("movementForm").addEventListener("submit", async e => {
    e.preventDefault();

    const productType = productTypeSelect.value;
    const brand = brandSelect.value;
    const model = modelSelect.value;
    const quantity = parseInt(document.getElementById("quantity").value, 10);
    const toDepartment = departmentSelect.value;
    const toBranch = branchSelect.value;
    const toPerson = personSelect.value;
    const productName = `${productType} - ${brand} - ${model}`;

    try {
      await addDoc(collection(db, "hareketler"), {
        date: Timestamp.now(),
        fromDepartment: "DEPO",
        toDepartment,
        toBranch,
        toPerson,
        productName,
        quantity
      });

      alert("Ürün başarıyla gönderildi!");
      e.target.reset();
      brandSelect.disabled = true;
      modelSelect.disabled = true;
      branchSelect.disabled = true;
      personSelect.disabled = true;
    } catch (error) {
      console.error("Gönderim hatası:", error);
      alert("Gönderim sırasında hata oluştu.");
    }
  });

  // Sayfa yüklendiğinde personel verisini Firestore'dan çek
  loadPersonData();
  listeleHareketler();

</script>
